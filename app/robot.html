<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="jalousie-remote">
        <meta name="author" content="Vadim Markelov">

        <title>Jalousie Remote by Vadim Markelov</title>

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <!-- build:css styles/vendor.css -->
        <!-- bower:css -->
        <!-- endbower -->
        <!-- endbuild -->
        <!-- build:css(.tmp) styles/main.css -->
        <link rel="stylesheet" href="styles/main.css">
        <!-- endbuild -->

    </head>

<body>

      <div class="progress progress-striped">
        <div class="progress-bar progress-bar-success" role="progressbar" 
           aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
           style="width: 0%">
          <span class=""></span>
        </div>
      </div>
      <div class="user"></div>


        <!-- build:js scripts/vendor.js -->
        <!-- bower:js -->
        <script src="../bower_components/jquery/dist/jquery.js"></script>
        <!-- endbower -->
        <!-- endbuild -->

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-49618193-1');ga('send','pageview');
        </script>

        <script>
            function Log(commandCount){

                var _URL='cmd?command=getlog'+(commandCount?('&count='+commandCount):'');

                var _request;

                this.getLog=function(){
                    var def=$.Deferred();
                    if(_request){
                        if(_request.readyState < 4){//abort previous request
                            _request.abort();
                        }
                    }
                    _request=$.ajax({
                        cache: false,
                        url: _URL,
                        method: 'GET',
                        dataType: 'json',
                        success: function(data){
                            def.resolve(data);
                        },
                        error: function(jqXHR, exception){
                            if (exception === 'abort') {
                                return;
                            }
                            def.reject();
                        }
                    });

                    return def.promise();
                };

            }


            // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
            // http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
             
            // requestAnimationFrame polyfill by Erik MÃ¶ller. fixes from Paul Irish and Tino Zijdel
             
            // MIT license
             
            (function() {
                var lastTime = 0;
                var vendors = ['ms', 'moz', 'webkit', 'o'];
                for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
                    window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                               || window[vendors[x]+'CancelRequestAnimationFrame'];
                }
             
                if (!window.requestAnimationFrame)
                    window.requestAnimationFrame = function(callback, element) {
                        var currTime = new Date().getTime();
                        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                        var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
                          timeToCall);
                        lastTime = currTime + timeToCall;
                        return id;
                    };
             
                if (!window.cancelAnimationFrame)
                    window.cancelAnimationFrame = function(id) {
                        clearTimeout(id);
                    };
            }());

            $(function(){
              var TheLog= new Log(1);

              var tickIndicator=$('.progress .progress-bar');
              var timer=0;

              //control if user is on the page
              var pageHasBeenActive;
              var AFhandler= function() {
                pageHasBeenActive=true;
                requestAnimationFrame(AFhandler);
              };
              AFhandler();

              var updateTick=function(){
                if(!pageHasBeenActive){
                  return;
                }
                pageHasBeenActive=!pageHasBeenActive;
                timer+=5;
                tickIndicator.css('width',timer+'%');
                tickIndicator.attr('aria-valuenow',timer);
                if(timer>=100) timer=0,update();
              };
              
              var update=function(){
                TheLog.getLog()
                .done(function(data){
                    switch(data[0].currentState){
                      case "close":
                        $('body').css('background-color', 'red');
                        break;
                      
                      case "open":
                        $('body').css('background-color', 'green');
                        break;

                    };
                    $('.user').html(data[0].user);
                })
                .fail(function(){
                    console.log('Error: con not get the log');
                });
              };

              setInterval(updateTick,100);
            });


    </script>


  </body>
</html>